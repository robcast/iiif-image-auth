# add CORS header to all responses
add_header Access-Control-Allow-Origin *;

# auth_request for image server in default_location file

# serve manifests
location /iiif/manifests/ {
    # CORS for Preflighted requests
    if ($request_method = OPTIONS ) {
      add_header "Access-Control-Allow-Origin"  "*";
      add_header "Access-Control-Allow-Headers" "Authorization";
      return 200;
    }
    
    # authenticate manifest requests
    auth_request /auth/query_auth;
    root /var/www/;
}

# auth service endpoint for proxy auth_request
location = /auth/query_auth {
  include uwsgi_params;
  uwsgi_pass auth:5000;
  uwsgi_pass_request_body off;
  # headers in uwsgi_param should be all uppercase!
  uwsgi_param HTTP_ORIGINAL_URI $request_uri;
}

# other auth service pages (without auth request barrier)
location /auth {
  auth_request off;
  include uwsgi_params;
  uwsgi_pass auth:5000;
  uwsgi_pass_request_body on;
  # headers in uwsgi_param should be all uppercase!
  uwsgi_param HTTP_ORIGINAL_URI $request_uri;
}

# no auth for letsencrypt certbot
location /.well-known {
  auth_request off;
}

# no auth for favicon requests
location = /favicon.ico {
  auth_request off;
  try_files $uri $uri/ =404;
}
