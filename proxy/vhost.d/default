# add CORS header to all responses
add_header Access-Control-Allow-Origin *;

# auth_request for image server in default_location file

rewrite_log on;

# serve manifests
location /iiif/manifests/ {
    # authenticate manifest requests
#    auth_request /auth/query_auth;
    root /var/www/;
}

# auth service endpoint for proxy auth_request
location = /auth/query_auth {
  include uwsgi_params;
  uwsgi_pass auth:5000;
  uwsgi_pass_request_body off;
  # headers in uwsgi_param should be all uppercase!
  uwsgi_param HTTP_ORIGINAL_URI $request_uri;
}

# other auth service pages (without auth request barrier)
location /auth {
  auth_request off;
  include uwsgi_params;
  uwsgi_pass auth:5000;
  uwsgi_pass_request_body on;
  # headers in uwsgi_param should be all uppercase!
  uwsgi_param HTTP_ORIGINAL_URI $request_uri;
}

# proxy info.json requests through auth service
location ~ ^/iiif/images/.*/info.json$ {
  include uwsgi_params;
  uwsgi_pass auth:5000;
  uwsgi_pass_request_body on;
  # force URI for uwsgi (rewrite didn't work)
  uwsgi_param PATH_INFO /auth/iiif_info_proxy;
  # headers in uwsgi_param should be all uppercase!
  uwsgi_param HTTP_ORIGINAL_URI $request_uri;
}

# iipsrv for internal info.json access
location /iiif-internal {
  include fastcgi.conf;
  fastcgi_pass iipsrv-internal:9001;
}

# no auth for letsencrypt certbot
location /.well-known {
  auth_request off;
}

# no auth for favicon requests
location = /favicon.ico {
  auth_request off;
  try_files $uri $uri/ =404;
}
